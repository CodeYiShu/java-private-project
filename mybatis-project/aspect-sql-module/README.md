# 一、项目场景

项目说明：利用 AOP 织入过滤 SQL

在知识图谱项目中，数据是 `根据项目来划分权限的`，比如数据模型 1 是属于项目 1 的，数据模型 2 是属于项目 2 的，用户 A 如果是具备项目 1 的权限，那么就可以看到数据模型 1 的数据但是看不到数据模型 2 的数据。


> 数据有其所属项目的 id，比如数据模型表有 project_id 来说明她属于哪个项目


此时进行过滤的时候，我们需要 `连表去查询这个数据是不是属于当前用户所具备权限的项目`。


这样就需要每个开发的人，都去进行连表，导致的问题：

1. 需要 `为很多查询 SQL 加上这个连表权限校验的操作，代码冗余`
2. 有些开发 `甚至会忘记添加上校验，由于是直接写在 SQL，也不容易排查`


# 二、解决方案

解决的方案是：`注解` + `AOP` + `ThreadLocal` + `MybatisPlus 的过滤器`


步骤：

1. **自定义一个注解**：标注在 `查询方法` 上，多表查询时指定所查询表的别名，单表则不需要指定
2. **创建一个切面**：切入点是 `所有标注了注解的方法`

    1. 获取出当 `前用户具备权限的项目 id`
    2. 使用 `IN 拼接成一个 SQL 条件`，比如 project_id IN (1,2)
    3. 将拼接成的 SQL 条件 `存入当前线程 ThreadLocal 本地变量中`
3. **创建 Mybatis-Plus 的 InnerInterceptor 接口的实现类，也就是拦截器**

    1. 实现此接口的 `beforeQuery()`，她会在发起查询操作之前执行，会传入当前的执行器和所执行的 SQL
    2. 从当前线程的 `ThreadLocal 中获取出过滤项目的 SQL 条件`，`拼接到当前执行的 SQL 的 WHERE 语句后面`
    3. `替换执行器原先执行的 SQL 为拼接过滤项目的 SQL 语句`
